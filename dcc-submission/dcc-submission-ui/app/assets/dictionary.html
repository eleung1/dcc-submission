<html>
<head><title>Dictionary Viewer :: ICGC Submission</title>
<link rel="stylesheet" href="/stylesheets/app.css">
<link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.0.2/css/bootstrap.min.css">
<script src="/javascripts/vendor.js"></script>
<script src="dictionaryUtil.js"></script>
<script src="dictionaryViewer.js"></script>
<style type="text/css">
.toolbar {
   position:fixed;
   display:block;
   top:0px;
   height:35px;
   padding:5px;
   width:100%;
   overflow: visible;

   opacity:0.95;
   background-color:rgb(240, 240, 230);

   border-bottom-color: rgb(200, 200, 200);
   border-bottom-style: solid;
   border-bottom-width: 2px;
}

.toolbar_item {
  display: inline-block;
  margin-right: 1em;
}


.data-type-list {
   padding-left:1em;
   padding-right:1em;
   color: #666666;
   font-weight: bold;
}

.legend {
   border-left-style: solid;
   border-left-width: 22px;
   padding-left:2px;
   font-size:1.0em;
}

.tiny {
   padding-left: 0.15em;
   font-size: 0.75em;
}


// From Bostock's examples
.node {
  cursor: pointer;
}

.node circle {
  fill: #fff;
  stroke: steelblue;
  stroke-width: 1.5px;
  cursor: pointer;
}

.node text {
  font: 0.75em sans-serif;
  cursor: pointer;
}

.link {
  fill: none;
  stroke: #f1f1f1;
  stroke-width: 2.0px;
}




// Override bootstrap default styles to make UI less blobby-looking
th {
   font-size: 0.8em;
}

pre {
   background-color: rgb(250, 245, 245);
}

select {
   line-height: inherit;
   height: auto;
   width: 8em;
}

a {
   cursor: pointer;
}

.table-bordered>thead>tr>th,
.table-bordered>thead>tr>td,
.table-bordered>tbody>tr>td
{
   border-bottom-width: 0px;
   border-left-width: 0px;
   font-size: 12px;
}


</style>
</head>
<body>
<!-- toolbar -->
<div class="toolbar">
   <ul class="list-unstyled">
      <li class="toolbar_item">
          <img src="https://dcc.icgc.org/styles/images/icgc-logo.png" width="25px"></img> 
          <span style="font-size:1.7rem; vertical-align:middle">
              <span style="color:#777777">ICGC</span>
              <span> Dictionary Viewer</span>
          <span>
      </li>
      <li class="toolbar_item">|</li>
      <li class="toolbar_item">
          <input style="margin-bottom:0" id="filter" type="text" size="30" onKeyUp="doFilter()" placeholder="Search"></input>
      </li>
      <li class="toolbar_item">From <select id="version_from" onChange="switchDictionary()"></select></li>
      <li class="toolbar_item">To  <select id="version_to" onChange="switchDictionary()"></select></li>
      <li class="toolbar_item">|</li>
      <li class="toolbar_item">
          <span style="position:absolute; margin:2px; color:#EEE"><span class="tiny" id="counterNew"></span></span>
          <span id="labelNew" class="legend">New</span>
      </li>
      <li class="toolbar_item">
          <span style="position:absolute; margin:2px; color:#EEE"><span class="tiny" id="counterChanged"></span></span>
          <span id="labelChanged" class="legend">Changed</span>
      </li>
      <li class="toolbar_item">
          <button><div id="viewReport">View Report</div></button>
      </li>
      <li class="toolbar_item">|</li>
      <li class="toolbar_item">
          <button id="viewToggle"></button>
      </li>
   </ul>
</div>
<!---->

<div id="visWrapper" style="margin:0.5em">
   <!-- template for table viewer-->
   <span id="datatypeSelector" style="display:inline-block; margin-right:10em; float:right">
       <button id="minimapLabel"><span>all</span><i class="glyphicon glyphicon-chevron-down"></i></button><br>
       <div  id="minimapWrapper" style="height:400px; width:285px; overflow:scroll; display:none; position:absolute; background-color:#F5F5F5">
          <svg id="minimap" height="0px" width="275px" style="pointer-events:visibleFill; z-index:10"></svg>
       </div>
   </span>
   <div id="datatypeTable"></div>

   <!-- template for graph viewer -->
   <div id="datatypeGraph">
      <div id="graph" style="float:left; width:75%"></div>
   </div>
</div>



<!-- template for report -->
<div id="reportWrapper" style="margin:0.5em; display:none">
   <div id="changeReport"></div>
</div>
<!---->

</body>
<script>

////////////////////////////////////////////////////////////////////////////////
// DCC Dictionary viewer
// Browse and compare ICGC data dictionaries
//
// Note:
// - The viewer does not support dictionary versions before 0.6c, this also means
//   the viewer assumes a fixed column order
// - Comparing A=>B will not yield the same result as B=>A due to how new/remove
//   items are calculated
//
// Dependencies:
// - Core: D3, Underscore
// - Styles: HighlightJS, JS-Beautify, regex-colorizer JS, Bootstrap
//
////////////////////////////////////////////////////////////////////////////////


var dictUtil = null;
var tableViewer = null;

var isReport = false;


// Other constants
var codelistMap = {};


function getSelect(elem) {
   var index = d3.select(elem).node().selectedIndex;
   return d3.select(elem).node()[index].value;
}


function switchDictionary() {
   render();
   generateChangeList(); 
}

function doFilter() {
   var txt = d3.select("#filter").node().value;
   tableViewer.filter(txt);
}


function render() {
   var versionFrom = getSelect("#version_from");
   var versionTo = getSelect("#version_to");

   if (tableViewer.isTable) {
      tableViewer.selectDataType("all");
      tableViewer.showDictionaryTable(versionFrom, versionTo);
   } else {
      tableViewer.showDictionaryGraph(versionFrom, versionTo);
   }
   doFilter();
}


function generateChangeList() {
   var versionFrom = getSelect("#version_from");
   var versionTo = getSelect("#version_to");
   var changeReport = dictUtil.createDiffListing(versionFrom, versionTo);

   d3.select("#changeReport").html("");
   d3.select("#changeReport").append("pre").text(function() {
      var text = "";
      text += "\nAdded:\n";
      changeReport.fieldsAdded.forEach(function(field) {
         text += field.fileType + "|" + field.fieldName + "\n";
      });
      text += "\nChanged:\n";
      changeReport.fieldsChanged.forEach(function(field) {
         text += field.fileType + "|" + field.fieldName + "|" + field.changes + "\n";
      });
      text += "\nRemoved:\n";
      changeReport.fieldsRemoved.forEach(function(field) {
         text += field.fileType + "|" + field.fieldName + "\n";
      });

      return text;
   });

   d3.select("#counterNew").text(function() {
      return changeReport.fieldsAdded.length;
   });
   d3.select("#counterChanged").text(function() {
      return changeReport.fieldsChanged.length;
   });
}



////////////////////////////////////////////////////////////////////////////////
// Entry point, setting up user interaction events
////////////////////////////////////////////////////////////////////////////////
d3.json("/ws/dictionaries", function(dictionaryList) {

   dictUtil = new DictionaryUtil(dictionaryList);
   tableViewer = new TableViewer(dictUtil, null);


   // Externalized function
   tableViewer.toggleFunc = function() {
      tableViewer.isTable = !tableViewer.isTable;
      d3.select("#viewToggle").selectAll("*").remove();

      if (tableViewer.isTable) {
         d3.select("#viewToggle").append("i").classed("glyphicon glyphicon-picture", true);
         d3.select("#viewToggle").append("span").text("  Graph View");
      } else {
         d3.select("#viewToggle").append("i").classed("glyphicon glyphicon-list-alt", true);
         d3.select("#viewToggle").append("span").text("  Table View");
      }
      var ver = getSelect("#version_to");
      render(ver);
   };

   d3.select("#filter").on("click", function() {
      d3.event.stopPropagation();
   });

   d3.select("#viewToggle").on("click", function() {
      tableViewer.toggleFunc();
   });

   d3.select("#viewReport").datum({isOpen:false}).on("click", function(d) {
      d.isOpen = !d.isOpen;
      d3.select("#viewReport").text(function() {
         return d.isOpen? "Close Report" : "View Report";
      });

      if (d.isOpen) {
         d3.select("#visWrapper").style("display", "none");
         d3.select("#viewToggle").style("display", "none");
         d3.select("#reportWrapper").style("display", "block");
         generateChangeList();
      } else {
         d3.select("#visWrapper").style("display", "block");
         d3.select("#viewToggle").style("display", "block");
         d3.select("#reportWrapper").style("display", "none");
      }
   });


   d3.select("#version_to").selectAll("option")
     .data(dictUtil.versionList)
     .enter()
     .append("option")
     .attr("value", function(d) { return d; })
     .text(function(d) { return d;});

   d3.select("#version_from").selectAll("option")
     .data(dictUtil.versionList)
     .enter()
     .append("option")
     .attr("value", function(d) { return d; })
     .text(function(d) { return d;});

   d3.select("#labelNew").style("color", tableViewer.colourNew);
   d3.select("#labelChanged").style("color", tableViewer.colourChanged);


   // Grab the codelist
   d3.json("/ws/codeLists", function(codeLists) {
     codeLists.forEach(function(c) {
        codelistMap[c.name] = c;
     });

     // Done preparing data, now start rendering, this may be flaky
     // because we are attempting to guess the correct dictionaries
     tableViewer.toggleFunc();
     if (d3.select("#version_from").node().children.length > 1) {
        d3.select("#version_from").node().selectedIndex = 1;
     }
     switchDictionary();

   });

});
</script>
</html>
