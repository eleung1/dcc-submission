#!/bin/bash
#
# Copyright 2013(c) The Ontario Institute for Cancer Research. All rights reserved.
#
# Description:
#   Creates a new dcc-heliotrope.jar and deploys to artifactory. Requires you to have
#   a Maven ~/.m2/settings.xml defined with artifactory credentials defined for
#   repository 'wrench.res.oicr.on.ca'.
#
# Usage:
#  ./deploy

# Configuration
basedir=$(dirname $(readlink -m $(dirname $0i)))

server="http://seqwaremaven.oicr.on.ca/artifactory"
repo="dcc-dependencies"
name="dcc-heliotrope"
artifact="org/icgc/dcc/$name"
path="$server/$repo/$artifact"
version=`curl -s "$path/maven-metadata.xml" | grep latest | sed "s/.*<latest>\([^<]*\)<\/latest>.*/\1/"`
version=`expr $version + 1`

# Output
datadir=$basedir/$version
genefile=genes.bson
reactomefile=UniProt2Reactome_v48.txt
genelistfile=cancer_gene_census.tsv
jarfile=$name.jar
rm -rf $datadir
mkdir $datadir

# Copy gene data
echo "scp hproxy-dev.res.oicr.on.ca:/nfs/dcc_secure/dcc/data/gene_model/ensembl_75/genes.bson $datadir/$genefile"
scp hproxy-dev.res.oicr.on.ca:/nfs/dcc_secure/dcc/data/gene_model/ensembl_75/genes.bson $datadir/$genefile

echo "scp hproxy-dev.res.oicr.on.ca:/u/dcc_dev/dcc-import/data/UniProt2Reactome_v48.txt $datadir/UniProt2Reactome_v48.txt"
scp hproxy-dev.res.oicr.on.ca:/u/dcc_dev/dcc-import/data/$reactomefile $datadir/$reactomefile

echo "scp hproxy-dev.res.oicr.on.ca:/u/dcc_dev/dcc-import/data/cancer_gene_census.tsv $datadir/cancer_gene_census.tsv"
scp hproxy-dev.res.oicr.on.ca:/u/dcc_dev/dcc-import/data/$genelistfile $datadir/$genelistfile


# Jar
echo "jar -cvf $datadir/$jarfile -C $datadir $genefile -C $datadir $reactomefile -C $datadir $genelistfile"
jar -cvf $datadir/$jarfile -C $datadir $genefile -C $datadir $reactomefile -C $datadir $genelistfile

# Echo
jar -tvf $datadir/$jarfile

# Cleanup
# rm $datadir/$datafile

# Deploy
mvn deploy:deploy-file \
-DgroupId=org.icgc.dcc \
-DartifactId=$name \
-Dversion=$version \
-Dpackaging=jar \
-Dfile=$datadir/$jarfile \
-DgeneratePom=true \
-DrepositoryId=wrench.res.oicr.on.ca \
-Durl=$server/$repo
